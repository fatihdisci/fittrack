<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FitTrack – Offline Fitness İstatistik Takipçisi</title>

  <!-- iOS PWA (manifest gerekmiyor) -->
  <link rel="apple-touch-icon" href="icons/app-180.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="FitTrack" />
  <meta name="theme-color" content="#111111" />

  <style>
    :root { --bg:#121212; --card:#1e1e1e; --text:#fff; --muted:#9aa0a6; --accent:#4caf50; --danger:#ff6b6b; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;background:linear-gradient(0deg,rgba(18,18,18,.7),var(--bg));backdrop-filter:blur(6px);z-index:10}
    .wrap{max-width:960px;margin:0 auto;padding:16px} h1{margin:0 0 8px;font-size:22px}
    .card{background:var(--card);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    label{display:block;font-size:13px;color:var(--muted);margin:6px 0 4px}
    input,select,button{width:100%;padding:12px;border-radius:12px;border:1px solid #2a2a2a;background:#151515;color:var(--text)}
    button{background:var(--accent);border:none;font-weight:600;cursor:pointer} button.ghost{background:#151515} button.danger{background:var(--danger)}
    .row{display:grid;gap:12px} @media(min-width:740px){.row.cols-2{grid-template-columns:1fr 1fr}}
    .set-row{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-top:8px}
    .badge{display:inline-block;background:#222;padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center} .right{margin-left:auto}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace} .hint{font-size:12px;color:var(--muted)}
    #chartImg{width:100%;border-radius:12px;background:#101010}
  </style>
</head>
<body>
<header><div class="wrap">
  <h1>FitTrack <span class="badge">offline • Python ile istatistik</span></h1>
  <div class="hint">Hangi gün–hangi hareket–kaç kg–kaç set–kaç tekrar: kaydet, trendi ve PR’ları gör.</div>
</div></header>

<main class="wrap">
  <!-- Kayıt Ekle -->
  <section class="card">
    <h2 style="margin:0 0 8px">Yeni Kayıt</h2>
    <div class="row cols-2">
      <div>
        <label>Tarih</label>
        <input type="date" id="dateInput">
      </div>
      <div>
        <label>Hareket</label>
        <input type="text" id="exerciseInput" placeholder="Örn: Bench Press" list="exerciseList">
        <datalist id="exerciseList"></datalist>
      </div>
    </div>

    <label>Setler (kg × tekrar)</label>
    <div id="setsBox" class="sets">
      <div class="set-row">
        <input inputmode="decimal" placeholder="kg">
        <input inputmode="numeric" placeholder="tekrar">
        <button type="button" class="ghost" onclick="removeSet(this)">Sil</button>
      </div>
    </div>

    <div class="flex" style="margin-top:10px">
      <button type="button" class="ghost" onclick="addSet()">+ Set Ekle</button>
      <div class="right"></div>
      <button type="button" onclick="saveEntry()">Kaydet</button>
    </div>
    <div class="hint" style="margin-top:8px">e1RM (Epley) ve Toplam Hacim (kg×tekrar) otomatik hesaplanır.</div>
  </section>

  <!-- Görünüm & Analiz -->
  <section class="card">
    <h2 style="margin:0 0 8px">Geçmiş, PR ve Trend</h2>
    <div class="row cols-2">
      <div>
        <label>Hareket seç</label>
        <select id="filterExercise"></select>
      </div>
      <div>
        <label>Sırala</label>
        <select id="sortMode">
          <option value="dateDesc">Tarih ↓ (Yeni→Eski)</option>
          <option value="dateAsc">Tarih ↑ (Eski→Yeni)</option>
          <option value="bestSet">En İyi e1RM</option>
        </select>
      </div>
    </div>

    <div class="flex" style="margin:12px 0">
      <button class="ghost" onclick="exportJSON()">Dışa Aktar (JSON)</button>
      <input type="file" accept="application/json" id="importFile" style="display:none">
      <button class="ghost" onclick="document.getElementById('importFile').click()">İçe Aktar</button>
      <div class="right"></div>
      <button class="danger" onclick="wipeData()">Tüm Veriyi Sil</button>
    </div>

    <img id="chartImg" alt="Trend Grafiği (Python)" />
    <div id="metrics" style="margin-top:10px" class="hint mono"></div>

    <div id="list" style="margin-top:12px;border-top:1px solid #2a2a2a"></div>
  </section>
</main>

<!-- Pyodide (Python) -->
<script defer src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

<script>
/* ===== IndexedDB ===== */
const DB='fittrack-db', STORE='entries'; let db, entries=[];
function idbOpen(){return new Promise((res,rej)=>{const r=indexedDB.open(DB,1);r.onupgradeneeded=e=>{
  const d=e.target.result, os=d.createObjectStore(STORE,{keyPath:'id',autoIncrement:true});
  os.createIndex('by_exercise','exercise'); os.createIndex('by_date','date');
}; r.onsuccess=()=>{db=r.result;res();}; r.onerror=()=>rej(r.error);});}
function idbAdd(o){return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readwrite');tx.objectStore(STORE).add(o).onsuccess=()=>res();tx.onerror=()=>rej(tx.error);});}
function idbAll(){return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readonly');const a=[];tx.objectStore(STORE).openCursor().onsuccess=e=>{const c=e.target.result;if(c){a.push(c.value);c.continue();}else res(a)};tx.onerror=()=>rej(tx.error);});}
function idbClear(){return new Promise((res,rej)=>{const tx=db.transaction(STORE,'readwrite');tx.objectStore(STORE).clear().onsuccess=()=>res();tx.onerror=()=>rej(tx.error);});}

/* ===== UI Helpers ===== */
const dateInput=document.getElementById('dateInput');
const exerciseInput=document.getElementById('exerciseInput');
const exerciseList=document.getElementById('exerciseList');
const setsBox=document.getElementById('setsBox');
const filterExercise=document.getElementById('filterExercise');
const sortMode=document.getElementById('sortMode');
const listDiv=document.getElementById('list');
const chartImg=document.getElementById('chartImg');
const metricsDiv=document.getElementById('metrics');
const importFile=document.getElementById('importFile');

function todayISO(){const t=new Date();return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;}

function addSet(w='',r=''){
  const row=document.createElement('div'); row.className='set-row';
  row.innerHTML=`<input inputmode="decimal" placeholder="kg" value="${w}">
                 <input inputmode="numeric" placeholder="tekrar" value="${r}">
                 <button type="button" class="ghost" onclick="removeSet(this)">Sil</button>`;
  setsBox.appendChild(row);
}
function removeSet(btn){
  const rows=[...setsBox.querySelectorAll('.set-row')];
  if(rows.length<=1){ rows[0].querySelectorAll('input').forEach(i=>i.value=''); return; }
  btn.parentElement.remove();
}
function getSets(){
  const rows=[...setsBox.querySelectorAll('.set-row')], out=[];
  for(const r of rows){
    const w=parseFloat((r.children[0].value||'').replace(',','.'));
    const rep=parseInt(r.children[1].value||'',10);
    if(!isNaN(w)&&!isNaN(rep)&&w>0&&rep>0) out.push({w,rep});
  }
  return out;
}

/* ===== Pyodide (Python) ===== */
let pyodideReady=null;
async function ensurePyodide(){
  if(pyodideReady) return pyodideReady;
  pyodideReady = new Promise(async (resolve)=>{
    const py = await loadPyodide({indexURL:"https://cdn.jsdelivr.net/pyodide/v0.25.0/full/"});
    await py.runPythonAsync(`
import sys, json, math, io, base64
import matplotlib
matplotlib.use("Agg")
import matplotlib.pyplot as plt
from datetime import datetime

def epley(w, rep): return w * (1 + rep/30)

def analyze_and_plot(raw_json, selected_ex):
    # raw_json: JS'ten gelen tüm kayıtlar (list[dict])
    data = json.loads(raw_json)

    # Filtrelenmiş veri (seçili hareket)
    filtered = [d for d in data if (selected_ex=="__all__" or d["exercise"]==selected_ex)]
    # Listeleme için satırları hazırla
    rows=[]
    for d in filtered:
        best = max(epley(s["w"], s["rep"]) for s in d["sets"])
        volume = sum(s["w"]*s["rep"] for s in d["sets"])
        rows.append({
            "date": d["date"], "exercise": d["exercise"],
            "best_e1rm": round(best,1), "volume": round(volume,1),
            "sets": "  •  ".join([f'{s["w"]}kg×{s["rep"]}' for s in d["sets"]])
        })

    # Grafik için: seçili harekette gün bazlı en iyi e1RM
    trend=[]
    if selected_ex!="__all__":
        per_date={}
        for d in data:
            if d["exercise"]!=selected_ex: continue
            b=max(epley(s["w"], s["rep"]) for s in d["sets"])
            per_date[d["date"]] = max(per_date.get(d["date"],0), b)
        trend = sorted(per_date.items(), key=lambda x: x[0])

    img_b64=""
    if len(trend)>=2:
        xs=[datetime.strptime(t,"%Y-%m-%d") for t,_ in trend]
        ys=[v for _,v in trend]
        plt.figure(figsize=(7,3), dpi=160)
        plt.plot(xs, ys, linewidth=3)
        plt.scatter(xs, ys)
        plt.title(f"{selected_ex} – En iyi e1RM (Epley)")
        plt.xlabel("Tarih"); plt.ylabel("kg"); plt.grid(alpha=.25)
        buf=io.BytesIO(); plt.tight_layout(); plt.savefig(buf, format="png"); plt.close()
        img_b64=base64.b64encode(buf.getvalue()).decode()

    # Genel metrikler
    total_sessions=len(filtered)
    global_best = max((r["best_e1rm"] for r in rows), default=0)
    total_volume = sum(r["volume"] for r in rows)
    prs=[]
    # PR tespiti: aynı hareket için tarihe göre artan en iyi e1RM yakalandığında işaretle
    if selected_ex!="__all__" and len(trend)>0:
        running=-1
        for d,v in trend:
            if v>running:
                prs.append({"date":d,"e1rm":round(v,1)})
                running=v

    return json.dumps({
        "rows": rows,
        "img_b64": img_b64,
        "metrics": {
            "total_sessions": total_sessions,
            "global_best": round(global_best,1) if global_best else 0,
            "total_volume": round(total_volume,1)
        },
        "prs": prs
    })
`);
    resolve(py);
  });
  return pyodideReady;
}

/* ===== Render & Hesap ===== */
function fillExerciseOptions(){
  const names=[...new Set(entries.map(e=>e.exercise))].sort((a,b)=>a.localeCompare(b,'tr'));
  exerciseList.innerHTML = names.map(n=>`<option value="${n}">`).join('');
  filterExercise.innerHTML = ['<option value="__all__">Tümü</option>', ...names.map(n=>`<option>${n}</option>`)].join('');
}

async function render(){
  // Liste görünümü (sıralama)
  const f=filterExercise.value||"__all__";
  let filtered=[...entries];
  if(f!=="__all__") filtered=filtered.filter(e=>e.exercise===f);

  const mode=sortMode.value||"dateDesc";
  if(mode==="dateDesc") filtered.sort((a,b)=>b.date.localeCompare(a.date));
  else if(mode==="dateAsc") filtered.sort((a,b)=>a.date.localeCompare(b.date));
  else if(mode==="bestSet"){
    const best=(x)=>Math.max(...x.sets.map(s=>s.w*(1+s.rep/30)));
    filtered.sort((a,b)=>best(b)-best(a));
  }

  listDiv.innerHTML = filtered.map(item=>{
    const best=Math.max(...item.sets.map(s=>s.w*(1+s.rep/30)));
    const vol=item.sets.reduce((t,s)=>t+s.w*s.rep,0);
    const setsTxt=item.sets.map(s=>`${s.w}kg×${s.rep}`).join('  •  ');
    return `<div style="display:flex;justify-content:space-between;gap:8px;padding:10px 0;border-bottom:1px solid #2a2a2a">
      <div>
        <div><strong>${item.exercise}</strong> <span class="badge">${item.date}</span></div>
        <div class="hint mono">${setsTxt}</div>
      </div>
      <div class="mono" style="text-align:right">
        e1RM ≈ ${best.toFixed(1)} kg<br><span class="hint">Hacim: ${vol.toFixed(0)} kg</span>
      </div>
    </div>`;
  }).join('');

  // Python tarafı: analiz + grafik
  const py = await ensurePyodide();
  const resultJSON = await py.runPythonAsync(`analyze_and_plot(${JSON.stringify(JSON.stringify(entries))!=='undefined'?JSON.stringify(JSON.stringify(entries)):'"[]"'} , ${JSON.stringify(f)})`);
  const result = JSON.parse(resultJSON);

  // Grafik
  if(result.img_b64){
    chartImg.src = `data:image/png;base64,${result.img_b64}`;
    chartImg.style.display='block';
  }else{
    chartImg.removeAttribute('src');
    chartImg.style.display='none';
  }

  // Metrikler + PR
  const m=result.metrics;
  const prsTxt = (result.prs||[]).map(p=>`${p.date} → ${p.e1rm}kg`).join(' | ');
  metricsDiv.textContent = `Seans: ${m.total_sessions}  •  Toplam hacim: ${m.total_volume} kg  •  En iyi e1RM: ${m.global_best} kg${prsTxt?`  •  PR: ${prsTxt}`:''}`;
}

/* ===== Events ===== */
async function saveEntry(){
  const date = dateInput.value || todayISO();
  const exercise = exerciseInput.value.trim();
  const sets = getSets();
  if(!exercise){ alert('Hareket adı gerekli'); return; }
  if(sets.length===0){ alert('En az 1 set ekleyin'); return; }
  await idbAdd({date, exercise, sets, ts:Date.now()});
  entries = await idbAll();
  exerciseInput.value=''; setsBox.innerHTML=''; addSet();
  fillExerciseOptions(); render();
}
function exportJSON(){
  const blob=new Blob([JSON.stringify(entries)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='fittrack-export.json'; a.click(); URL.revokeObjectURL(a.href);
}
importFile.addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const text=await f.text(); const arr=JSON.parse(text); if(!Array.isArray(arr)) throw new Error('Geçersiz JSON');
    await idbClear(); await Promise.all(arr.map(o=>idbAdd(o)));
    entries=await idbAll(); fillExerciseOptions(); render(); alert('İçe aktarıldı.');
  }catch(err){ alert('Hata: '+err.message); }
});
async function wipeData(){
  if(!confirm('Tüm verileri silmek istiyor musun?')) return;
  await idbClear(); entries=[]; fillExerciseOptions(); render();
}

/* ===== SW ===== */
if('serviceWorker' in navigator){ window.addEventListener('load', ()=>navigator.serviceWorker.register('./sw.js')); }

/* ===== Init ===== */
(async function init(){
  await idbOpen();
  entries = await idbAll();
  dateInput.value = todayISO();
  addSet(); fillExerciseOptions(); render();
})();
</script>
</body>
</html>
