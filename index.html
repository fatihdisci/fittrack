<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>FitTrack — Set Günlüğü (PWA)</title>

  <!-- iOS için uygulama ikonu ve PWA meta'ları -->
  <link rel="apple-touch-icon" href="icons/app-180.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="FitTrack" />
  <meta name="theme-color" content="#0b0b0d" />

  <style>
    :root{
      --bg: #0b0b0d;
      --bg-elev: #121316;
      --card: #16181c;
      --text: #f6f7f9;
      --muted:#9aa0a6;
      --accent:#4caf50;
      --accent-2:#21c47b;
      --danger:#ff6464;
      --ring: rgba(76,175,80,.22);
      --radius: 18px;
      --shadow-lg: 0 20px 50px rgba(0,0,0,.5);
      --shadow-sm: 0 6px 18px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html{height:-webkit-fill-available; background:var(--bg)}
    body{
      margin:0; color:var(--text);
      background:
        radial-gradient(1200px 600px at 80% -200px, rgba(76,175,80,.12), transparent 60%),
        radial-gradient(900px 500px at -200px 60%, rgba(33,196,123,.08), transparent 60%),
        linear-gradient(180deg, #0a0b0d, #0c0d10);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      min-height: 100dvh;
    }
    .appbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: saturate(1.2) blur(12px);
      background: linear-gradient(180deg, rgba(10,11,13,.9), rgba(10,11,13,.6));
      border-bottom:1px solid rgba(255,255,255,.04);
      padding-top: env(safe-area-inset-top);
    }
    .wrap{max-width:980px; margin:0 auto; padding:16px;}
    .appbar .wrap{padding-top:10px; padding-bottom:8px}
    .title{display:flex; align-items:center; gap:12px}
    .logo{width:28px; height:28px; display:grid; place-items:center; border-radius:8px;
      background: linear-gradient(180deg, #27ae60, #1e8e4a); box-shadow: inset 0 1px 0 rgba(255,255,255,.2)}
    .pill{font-size:12px; color:#bfc5cc; background:#0f1114; border:1px solid #1f232a; padding:4px 10px; border-radius:999px}
    h1{margin:0; font-size:20px; letter-spacing:.2px}
    .section{margin:18px 0}
    .card{
      background:
        linear-gradient(180deg, rgba(255,255,255,.02), transparent 35%),
        linear-gradient(0deg, rgba(255,255,255,.03), transparent 25%),
        var(--card);
      border:1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow-lg);
      border-radius: var(--radius);
      padding:16px;
    }
    .card h2{margin:0 0 10px; font-size:18px}
    label{display:block; font-size:13px; color:var(--muted); margin:6px 0 6px}
    input,select,button{
      width:100%; padding:12px 14px; border-radius:14px;
      border:1px solid #262a31; background: #0f1114; color:var(--text);
      transition: transform .12s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease, filter .18s ease;
    }
    input:focus,select:focus{
      outline:none; border-color: var(--accent); box-shadow: 0 0 0 4px var(--ring);
    }
    .row{display:grid; gap:12px}
    @media(min-width:760px){ .cols-2{ grid-template-columns:1fr 1fr } }
    .muted{color:var(--muted); font-size:12px}
    .btn{background: linear-gradient(180deg, var(--accent-2), var(--accent)); color:#05130a; font-weight:700; letter-spacing:.2px; border:none}
    .btn.ghost{background:#101215; color:var(--text); border:1px solid #252a31}
    .btn.danger{background: linear-gradient(180deg, #ff7b7b, #ff6464); color:#240808; border:none}
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:scale(.98)}
    .flex{display:flex; gap:10px; align-items:center}
    .right{margin-left:auto}
    .set-row{display:grid; grid-template-columns:1fr 1fr auto; gap:10px; margin-top:10px}
    .badge{display:inline-block; padding:4px 10px; border-radius:999px; background:#0f1114; border:1px solid #232831; color:#c6cbd2; font-size:12px}
    .list{margin-top:10px}
    .item{display:flex; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px dashed rgba(255,255,255,.08);}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}

    /* Tıklamada küçük ripple efekti */
    button{position:relative; overflow:hidden; isolation:isolate}
    button::after{
      content:""; position:absolute; left:var(--x,50%); top:var(--y,50%);
      width:0; height:0; background:rgba(255,255,255,.55); border-radius:999px;
      transform:translate(-50%,-50%); pointer-events:none; opacity:0;
      transition: width .45s ease, height .45s ease, opacity .6s ease;
      mix-blend-mode: soft-light;
    }
    button:active::after{ width:280px; height:280px; opacity:1 }

    /* Alttaki sabit bar (işlemler) */
    .navbar{
      position: sticky; bottom:0; z-index:40;
      background: linear-gradient(0deg, rgba(15,17,20,.96), rgba(15,17,20,.78));
      border-top:1px solid rgba(255,255,255,.05);
      backdrop-filter: blur(12px);
      padding-bottom: env(safe-area-inset-bottom);
    }
    .navbar .bar{display:flex; gap:10px; padding:10px}
    .navbar .bar .btn{flex:1}

    /* Küçük bildirim kutusu */
    #toast{position:fixed; left:50%; bottom:22px; transform:translateX(-50%) translateY(12px);
      background:#111317; border:1px solid #262b33; padding:10px 14px; border-radius:12px;
      color:#dfe5ec; font-weight:600; box-shadow:var(--shadow-sm); opacity:0; pointer-events:none;
      transition: all .35s ease; z-index:60}
    #toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

    /* Tartı en altta dursun ve alttaki barla çakışmasın */
    .tarti-bottom{
      margin-bottom: calc(env(safe-area-inset-bottom) + 88px);
    }

    /* "(Elle giriş)" kutusu sadece gerektiğinde görünsün */
    .hidden{display:none}
  </style>
</head>
<body>
  <!-- Üst başlık -->
  <div class="appbar">
    <div class="wrap title">
      <div class="logo">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 10h2v4H4zM18 10h2v4h-2zM7 9h10v6H7z" fill="white"/>
        </svg>
      </div>
      <h1>FitTrack</h1>
      <span class="pill">offline • PWA</span>
      <div class="right"></div>
    </div>
  </div>

  <div class="wrap">
    <!-- YENİ KAYIT: tarih + kas grubu + hareket + setler -->
    <section class="section card">
      <h2>Yeni Kayıt</h2>

      <div class="row cols-2">
        <div>
          <label>Tarih</label>
          <input type="date" id="dateInput">
        </div>
        <div>
          <label>Kas Grubu</label>
          <select id="muscleGroup"></select>
        </div>
      </div>

      <!-- Satır 1: Hareket seçimi -->
      <div class="row cols-2" style="margin-top:6px">
        <div>
          <label>Hareket</label>
          <select id="movement"></select>
        </div>
        <div></div>
      </div>

      <!-- Satır 2: Set sayısı şablonu + buton -->
      <div class="row cols-2" style="margin-top:6px">
        <div>
          <label>Set sayısı (şablon)</label>
          <select id="setCountSelect">
            <option>1</option><option>2</option><option>3</option>
            <option>4</option><option>5</option><option>6</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button type="button" class="btn ghost" id="templateBtn">Set Şablonu Uygula</button>
        </div>
      </div>

      <!-- Hareket listede yoksa "elle giriş" açılır (ID aynı: exerciseInput) -->
      <div id="customExerciseWrap" class="hidden">
        <label>Hareket (Elle Giriş)</label>
        <input type="text" id="exerciseInput" placeholder="Örn: Squat" list="exerciseList">
        <datalist id="exerciseList"></datalist>
      </div>

      <label style="margin-top:8px">Setler (kg <em>opsiyonel</em> × tekrar)</label>
      <div id="setsBox"></div>

      <div class="muted" style="margin-top:8px">Kilo girmezsen set <strong>BW×tekrar</strong> olarak kaydedilir.</div>
    </section>

    <!-- GEÇMİŞ: filtre + sıralama + liste -->
    <section class="section card">
      <h2>Geçmiş</h2>
      <div class="row cols-2">
        <div>
          <label>Hareket seç</label>
          <select id="filterExercise"></select>
        </div>
        <div>
          <label>Sırala</label>
          <select id="sortMode">
            <option value="dateDesc">Tarih ↓ (Yeni→Eski)</option>
            <option value="dateAsc">Tarih ↑ (Eski→Yeni)</option>
          </select>
        </div>
      </div>

      <div class="row list" id="list"></div>
    </section>

    <!-- TARTI GÜNLÜĞÜ: en altta -->
    <section class="section card tarti-bottom">
      <details id="weighBox">
        <summary style="cursor:pointer;display:flex;align-items:center;gap:8px">
          <strong>Tartı Günlüğü</strong>
          <span class="pill">Aç/Kapat</span>
        </summary>

        <div style="margin-top:12px">
          <div class="row cols-2">
            <div>
              <label>Tarih</label>
              <input type="date" id="wDate">
            </div>
            <div>
              <label>Kilo (kg)</label>
              <input type="number" id="wKg" inputmode="decimal" placeholder="Örn: 78.6" step="0.1">
            </div>
          </div>
          <div class="flex" style="margin-top:10px">
            <button class="btn" id="wSaveBtn">Kilo Kaydet</button>
            <div class="right"></div>
            <button class="btn ghost" id="wExportBtn">Dışa Aktar</button>
            <input type="file" accept="application/json" id="wImportFile" style="display:none">
            <button class="btn ghost" id="wImportBtn">İçe Aktar</button>
            <button class="btn danger" id="wWipeBtn">Temizle</button>
          </div>
          <div class="list" id="wList"></div>
        </div>
      </details>
    </section>

  </div> <!-- /wrap -->

  <!-- Alttaki işlem barı -->
  <div class="navbar">
    <div class="wrap bar">
      <button class="btn ghost" id="exportBtn">Dışa Aktar</button>
      <input type="file" accept="application/json" id="importFile" style="display:none">
      <button class="btn ghost" id="importBtn">İçe Aktar</button>
      <button class="btn danger" id="wipeBtn">Tüm Veriyi Sil</button>
      <button class="btn" id="saveBtn">Kaydet</button>
    </div>
  </div>

  <div id="toast">Kaydedildi ✓</div>

  <!-- Küçük geçiş animasyonları için -->
  <script src="https://cdn.jsdelivr.net/npm/@formkit/auto-animate@1.0.0-beta.6/dist/auto-animate.min.js"></script>

  <script>
    "use strict";

    /* =========================
       1) HAREKET VERİ SETİ
       Kas grubu → hareket listesi
       ========================= */
    const EXERCISES = {
      "Göğüs (Chest)": [
        "Bench Press (Düz Bench)",
        "Incline Bench Press",
        "Decline Bench Press",
        "Dumbbell Fly (Düz)",
        "Incline Dumbbell Fly",
        "Cable Crossover",
        "Push-Up (Şınav)"
      ],
      "Sırt (Back)": [
        "Pull-Up / Chin-Up",
        "Lat Pulldown (Öne)",
        "Barbell Row (Bent Over Row)",
        "T-Bar Row",
        "Seated Cable Row",
        "Deadlift",
        "Face Pull"
      ],
      "Omuz (Shoulders)": [
        "Overhead Press (Military Press)",
        "Dumbbell Lateral Raise",
        "Front Raise",
        "Rear Delt Fly",
        "Arnold Press",
        "Shrug"
      ],
      "Bacak (Legs)": [
        "Squat (Back Squat)",
        "Front Squat",
        "Lunge",
        "Leg Press",
        "Leg Extension",
        "Leg Curl",
        "Romanian Deadlift",
        "Calf Raise (Standing/Seated)"
      ],
      "Kol – Biceps": [
        "Barbell Curl",
        "Dumbbell Curl",
        "Hammer Curl",
        "Concentration Curl"
      ],
      "Kol – Triceps": [
        "Close Grip Bench Press",
        "Skull Crusher (EZ Bar Lying Extension)",
        "Overhead Dumbbell Extension",
        "Cable Pushdown",
        "Diamond Push-Up",
        "Dips"
      ],
      "Karın (Abs & Core)": [
        "Crunch",
        "Reverse Crunch",
        "Leg Raise / Hanging Leg Raise",
        "Plank",
        "Russian Twist",
        "Bicycle Crunch"
      ],
      "Tüm Vücut / Çoklu Kas": [
        "Deadlift",
        "Clean & Press",
        "Farmer’s Walk",
        "Burpee"
      ]
    };
    const CUSTOM_VALUE = "__custom__";

    /* =========================
       2) INDEXEDDB (kalıcı yerel veritabanı)
       entries: egzersiz kayıtları
       weighins: tartı verileri
       ========================= */
    const DB='fittrack-db', STORE='entries', WEIGH='weighins';
    let db, entries=[], weighs=[];

    // IndexedDB bağlantısı aç/oluştur (v2: weighins store eklendi)
    function idbOpen(){
      return new Promise((res,rej)=>{
        const r=indexedDB.open(DB,2);
        r.onupgradeneeded=e=>{
          const d=e.target.result;
          if(!d.objectStoreNames.contains(STORE)){
            const os=d.createObjectStore(STORE,{keyPath:'id',autoIncrement:true});
            os.createIndex('by_exercise','exercise');
            os.createIndex('by_date','date');
          }
          if(!d.objectStoreNames.contains(WEIGH)){
            const ws=d.createObjectStore(WEIGH,{keyPath:'id',autoIncrement:true});
            ws.createIndex('by_date','date');
          }
        };
        r.onsuccess=()=>{db=r.result;res();};
        r.onerror=()=>rej(r.error);
      });
    }
    function idbAdd(o){
      return new Promise((res,rej)=>{
        const tx=db.transaction(STORE,'readwrite');
        tx.objectStore(STORE).add(o).onsuccess=()=>res();
        tx.onerror=()=>rej(tx.error);
      });
    }
    function idbAll(){
      return new Promise((res,rej)=>{
        const tx=db.transaction(STORE,'readonly'); const a=[];
        tx.objectStore(STORE).openCursor().onsuccess=e=>{
          const c=e.target.result; if(c){a.push(c.value); c.continue();} else res(a);
        };
        tx.onerror=()=>rej(tx.error);
      });
    }
    function idbClear(){
      return new Promise((res,rej)=>{
        const tx=db.transaction(STORE,'readwrite');
        tx.objectStore(STORE).clear().onsuccess=()=>res();
        tx.onerror=()=>rej(tx.error);
      });
    }

    // Tartı için store yardımcıları
    function idbAddWeigh(o){
      return new Promise((res,rej)=>{
        const tx=db.transaction(WEIGH,'readwrite');
        tx.objectStore(WEIGH).add(o).onsuccess=()=>res();
        tx.onerror=()=>rej(tx.error);
      });
    }
    function idbAllWeigh(){
      return new Promise((res,rej)=>{
        const tx=db.transaction(WEIGH,'readonly'); const a=[];
        tx.objectStore(WEIGH).openCursor().onsuccess=e=>{
          const c=e.target.result; if(c){a.push(c.value); c.continue();} else res(a);
        };
        tx.onerror=()=>rej(tx.error);
      });
    }
    function idbClearWeigh(){
      return new Promise((res,rej)=>{
        const tx=db.transaction(WEIGH,'readwrite');
        tx.objectStore(WEIGH).clear().onsuccess=()=>res();
        tx.onerror=()=>rej(tx.error);
      });
    }

    /* =========================
       3) KOLAY YARDIMCILAR
       ========================= */
    function todayISO(){
      const t=new Date();
      return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
    }
    function trWeekday(iso){
      const [y,m,d]=iso.split('-').map(Number);
      const w=['Pazar','Pazartesi','Salı','Çarşamba','Perşembe','Cuma','Cumartesi'];
      return w[new Date(y,m-1,d).getDay()];
    }

    // DOM referansları
    const dateInput=document.getElementById('dateInput');
    const exerciseInput=document.getElementById('exerciseInput'); // arka planda gerçek hareket adı burada tutulur
    const exerciseList=document.getElementById('exerciseList');
    const setCountSelect=document.getElementById('setCountSelect');
    const setsBox=document.getElementById('setsBox');
    const filterExercise=document.getElementById('filterExercise');
    const sortMode=document.getElementById('sortMode');
    const listDiv=document.getElementById('list');
    const importFile=document.getElementById('importFile');
    const toast=document.getElementById('toast');

    const templateBtn=document.getElementById('templateBtn');
    const exportBtn=document.getElementById('exportBtn');
    const importBtn=document.getElementById('importBtn');
    const wipeBtn=document.getElementById('wipeBtn');
    const saveBtn=document.getElementById('saveBtn');

    // Kas grubu & hareket select'leri
    const muscleGroup = document.getElementById('muscleGroup');
    const movement = document.getElementById('movement');
    const customExerciseWrap = document.getElementById('customExerciseWrap');

    // Tartı UI
    const wDate=document.getElementById('wDate');
    const wKg=document.getElementById('wKg');
    const wSaveBtn=document.getElementById('wSaveBtn');
    const wExportBtn=document.getElementById('wExportBtn');
    const wImportBtn=document.getElementById('wImportBtn');
    const wImportFile=document.getElementById('wImportFile');
    const wWipeBtn=document.getElementById('wWipeBtn');
    const wList=document.getElementById('wList');

    /* =========================
       4) SET SATIRI OLUŞTURMA/ÇIKARMA
       ========================= */
    function addSet(w='',r=''){
      const row=document.createElement('div'); row.className='set-row';
      row.innerHTML=`
        <input inputmode="decimal" placeholder="kg (opsiyonel)" value="${w}">
        <input inputmode="numeric" placeholder="tekrar" value="${r}">
        <button type="button" class="btn ghost">Sil</button>
      `;
      const btn = row.querySelector('button');
      btn.addEventListener('click', ()=> removeSet(btn));
      setsBox.appendChild(row);
    }
    function removeSet(btn){
      const rows=[...setsBox.querySelectorAll('.set-row')];
      if(rows.length<=1){ rows[0]?.querySelectorAll('input').forEach(i=>i.value=''); return; }
      btn.parentElement.remove();
    }
    function applySetTemplate(){
      const n=parseInt(setCountSelect.value,10);
      setsBox.innerHTML='';
      for(let i=0;i<n;i++) addSet();
      if (window.autoAnimate) window.autoAnimate(setsBox);
    }
    function getSets(){
      const rows=[...setsBox.querySelectorAll('.set-row')], out=[];
      for(const r of rows){
        const wStr=(r.children[0].value||'').trim();
        const w = wStr==='' ? null : parseFloat(wStr.replace(',','.'));
        const the_rep = (r.children[1].value||'').trim();
        const rep=parseInt(the_rep,10);
        if(!isNaN(rep) && rep>0){
          if(w===null || (!isNaN(w) && w>0)) out.push({w,rep});
        }
      }
      return out;
    }

    /* =========================
       5) KAS GRUBU/HAREKET DOLDURMA
       ========================= */
    function populateGroups(){
      const groups = Object.keys(EXERCISES);
      muscleGroup.innerHTML = groups.map(g=>`<option value="${g}">${g}</option>`).join('');
      muscleGroup.appendChild(new Option("— (Elle seçeceğim) —", CUSTOM_VALUE));
    }
    function populateMovements(){
      const g = muscleGroup.value;
      let options = [];
      if(g && g !== CUSTOM_VALUE){
        options = EXERCISES[g] || [];
      }
      movement.innerHTML = options.map(n=>`<option value="${n}">${n}</option>`).join('');
      movement.appendChild(new Option("— (Listede yok / Elle giriş) —", CUSTOM_VALUE));

      // Varsayılan: ilk hareket → exerciseInput'a yaz ve "elle giriş"i kapat
      if(options.length>0){
        movement.value = options[0];
        exerciseInput.value = options[0];
        customExerciseWrap.classList.add('hidden');
      }else{
        movement.value = CUSTOM_VALUE;
        exerciseInput.value = '';
        customExerciseWrap.classList.remove('hidden');
      }
    }
    muscleGroup.addEventListener('change', ()=>{
      if(muscleGroup.value === CUSTOM_VALUE){
        movement.innerHTML = `<option value="${CUSTOM_VALUE}">— (Listede yok / Elle giriş) —</option>`;
        movement.value = CUSTOM_VALUE;
        exerciseInput.value = '';
        customExerciseWrap.classList.remove('hidden');
      }else{
        populateMovements();
      }
    });
    movement.addEventListener('change', ()=>{
      if(movement.value === CUSTOM_VALUE){
        exerciseInput.value = '';
        customExerciseWrap.classList.remove('hidden');
      }else{
        exerciseInput.value = movement.value;
        customExerciseWrap.classList.add('hidden');
      }
    });

    /* =========================
       6) GEÇMİŞ LİSTE/TOAST
       ========================= */
    function fillExerciseOptions(){
      const names=[...new Set(entries.map(e=>e.exercise))].sort((a,b)=>a.localeCompare(b,'tr'));
      exerciseList.innerHTML = names.map(n=>`<option value="${n}">`).join('');
      filterExercise.innerHTML = ['<option value="__all__">Tümü</option>', ...names.map(n=>`<option>${n}</option>`)].join('');
    }
    function render(){
      const f=filterExercise.value||"__all__";
      let filtered=[...entries];
      if(f!=="__all__") filtered=filtered.filter(e=>e.exercise===f);

      const mode=sortMode.value||"dateDesc";
      if(mode==="dateDesc") filtered.sort((a,b)=>b.date.localeCompare(a.date));
      else filtered.sort((a,b)=>a.date.localeCompare(b.date));

      listDiv.innerHTML = filtered.map(item=>{
        const totalReps = item.sets.reduce((t,s)=>t + (s.rep||0), 0);
        const volume = item.sets.filter(s=>s.w!==null).reduce((t,s)=>t + s.w*s.rep, 0);
        const anyWeighted = item.sets.some(s=>s.w!==null);
        const setsTxt = item.sets.map(s=> s.w===null ? `BW×${s.rep}` : `${s.w}kg×${s.rep}` ).join('  •  ');
        const right = anyWeighted
          ? `Hacim: ${volume.toFixed(0)} kg<br><span class="muted">Toplam tekrar: ${totalReps}</span>`
          : `Toplam tekrar: ${totalReps}`;
        return `<div class="item">
          <div>
            <div style="display:flex;align-items:center;gap:8px">
              <strong>${item.exercise}</strong>
              <span class="badge">${item.date} (${trWeekday(item.date)})</span>
            </div>
            <div class="muted mono">${setsTxt}</div>
          </div>
          <div class="mono" style="text-align:right">${right}</div>
        </div>`;
      }).join('');
      if (window.autoAnimate) window.autoAnimate(listDiv);
    }
    function showToast(msg='Kaydedildi ✓'){
      toast.textContent = msg;
      toast.classList.add('show');
      if (navigator.vibrate) navigator.vibrate(20);
      setTimeout(()=>toast.classList.remove('show'), 1400);
    }

    /* =========================
       7) OTOMATİK ORTAK JSON YEDEK
       (entries + weighs birlikte)
       ========================= */
    function downloadJSON(filename, obj){
      const json = JSON.stringify(obj, null, 2);
      const blob = new Blob([json], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    function jsonAutoBackup(){
      // Açıklama: Her kayıttan sonra arka planda güncel yedek dosyası indirir.
      const now = new Date();
      const stamp = now.toISOString().slice(0,19).replace(/[:T]/g,'-'); // YYYY-MM-DD-HH-MM-SS
      const payload = { entries, weighs, exportedAt: now.toISOString() };
      downloadJSON(`fittrack-backup-${stamp}.json`, payload);
    }

    /* =========================
       8) KAYDET/DIŞA-İÇE AKTAR/SİL — EGZERSİZ
       ========================= */
    async function saveEntry(){
      const date = dateInput.value || todayISO();
      const exercise = (exerciseInput.value || '').trim(); // select veya elle girişten gelir
      const sets = getSets();
      if(!exercise){ alert('Hareket gerekli'); return; }
      if(sets.length===0){ alert('En az 1 set ekleyin'); return; }

      await idbAdd({date, exercise, sets, ts:Date.now()});
      entries = await idbAll();

      // Form temizliği: listeden seçildiyse sadece setleri sıfırla; elle girişte metni de temizle
      if(muscleGroup.value === CUSTOM_VALUE){ exerciseInput.value=''; }
      setsBox.innerHTML='';

      render(); fillExerciseOptions();
      showToast();
      jsonAutoBackup(); // ← Kaydettikten sonra otomatik ortak yedek indir
    }
    function exportJSON(){
      // Açıklama: Sadece egzersiz (entries) verilerini dışa aktarır.
      downloadJSON('fittrack-entries.json', entries);
    }
    async function wipeData(){
      if(!confirm('Tüm egzersiz verilerini silmek istiyor musun?')) return;
      await idbClear(); entries=[]; fillExerciseOptions(); render();
      showToast('Temizlendi ✓');
    }

    // Egzersiz İçe Aktar: Artık ortak yedeği (entries+weighs) de tanır
    importFile.addEventListener('change', async e=>{
      const f=e.target.files[0]; if(!f) return;
      try{
        const text=await f.text(); const data=JSON.parse(text);

        // Ortak yedek (entries + weighs) formatı
        if (data && typeof data === 'object' && (Array.isArray(data.entries) || Array.isArray(data.weighs))) {
          if (Array.isArray(data.entries)) {
            await idbClear();
            for (const o of data.entries) await idbAdd(o);
            entries = await idbAll();
          }
          if (Array.isArray(data.weighs)) {
            await idbClearWeigh();
            for (const w of data.weighs) await idbAddWeigh(w);
            weighs = await idbAllWeigh();
          }
          fillExerciseOptions(); render(); renderWeighs();
          showToast('Ortak yedek içe aktarıldı ✓');
          return;
        }

        // Eski tek format: sadece entries dizisi
        if(!Array.isArray(data)) throw new Error('Geçersiz JSON');
        await idbClear(); 
        await Promise.all(data.map(o=>idbAdd(o)));
        entries=await idbAll(); 
        fillExerciseOptions(); render(); 
        showToast('İçe aktarıldı ✓');
      }catch(err){ alert('Hata: '+err.message); }
      finally { e.target.value=''; } // aynı dosyayı tekrar seçebilmek için sıfırla
    });

    /* =========================
       9) KAYDET/DIŞA-İÇE AKTAR/SİL — TARTI
       ========================= */
    async function saveWeigh(){
      const date = (wDate.value || todayISO()).trim();
      const kg = parseFloat((wKg.value || '').replace(',','.'));
      if(isNaN(kg) || kg<=0){ alert('Geçerli bir kilo girin'); return; }
      await idbAddWeigh({date, kg, ts:Date.now()});
      weighs = await idbAllWeigh();
      wKg.value='';
      renderWeighs();
      showToast('Kilo kaydedildi ✓');
      jsonAutoBackup(); // ← Kaydettikten sonra otomatik ortak yedek indir
    }
    function exportWeighs(){
      // Açıklama: Sadece tartı (weighs) verilerini dışa aktarır.
      downloadJSON('fittrack-weighins.json', weighs);
    }
    async function wipeWeighs(){
      if(!confirm('Tüm tartı verilerini silmek istiyor musun?')) return;
      await idbClearWeigh(); weighs=[]; renderWeighs(); showToast('Tartı verileri temizlendi ✓');
    }
    function renderWeighs(){
      const sorted=[...weighs].sort((a,b)=>b.date.localeCompare(a.date));
      wList.innerHTML = sorted.map(w=>{
        return `<div class="item">
          <div><strong>${w.kg.toFixed(1)} kg</strong> <span class="badge">${w.date} (${trWeekday(w.date)})</span></div>
          <div class="muted mono">tartı</div>
        </div>`;
      }).join('');
      if (window.autoAnimate) window.autoAnimate(wList);
    }

    // Tartı İçe Aktar: Ortak yedeği (entries+weighs) de tanır
    wImportFile.addEventListener('change', async e=>{
      const f=e.target.files[0]; if(!f) return;
      try{
        const text=await f.text(); const data=JSON.parse(text);

        // Ortak yedek (entries + weighs) formatı
        if (data && typeof data === 'object' && (Array.isArray(data.entries) || Array.isArray(data.weighs))) {
          if (Array.isArray(data.entries)) {
            await idbClear();
            for (const o of data.entries) await idbAdd(o);
            entries = await idbAll();
          }
          if (Array.isArray(data.weighs)) {
            await idbClearWeigh();
            for (const w of data.weighs) await idbAddWeigh(w);
            weighs = await idbAllWeigh();
          }
          fillExerciseOptions(); render(); renderWeighs();
          showToast('Ortak yedek içe aktarıldı ✓');
          return;
        }

        // Eski tek format: sadece weighs dizisi
        if(!Array.isArray(data)) throw new Error('Geçersiz JSON');
        await idbClearWeigh(); 
        await Promise.all(data.map(o=>idbAddWeigh(o)));
        weighs=await idbAllWeigh(); 
        renderWeighs(); 
        showToast('Tartı verileri içe aktarıldı ✓');
      }catch(err){ alert('Hata: '+err.message); }
      finally { e.target.value=''; }
    });

    /* =========================
       10) BUTON BAĞLANTILARI
       ========================= */
    document.getElementById('templateBtn').addEventListener('click', applySetTemplate);
    document.getElementById('exportBtn').addEventListener('click', exportJSON);
    document.getElementById('importBtn').addEventListener('click', ()=> importFile.click());
    document.getElementById('wipeBtn').addEventListener('click', wipeData);
    document.getElementById('saveBtn').addEventListener('click', saveEntry);

    document.getElementById('wSaveBtn').addEventListener('click', saveWeigh);
    document.getElementById('wExportBtn').addEventListener('click', exportWeighs);
    document.getElementById('wImportBtn').addEventListener('click', ()=> wImportFile.click());
    document.getElementById('wWipeBtn').addEventListener('click', wipeWeighs);

    /* =========================
       11) KÜÇÜK DOKUNUŞLAR
       ========================= */
    // Ripple efekti için tıklama koordinatı
    function setRipple(e){
      const b=e.target.closest('button'); if(!b) return;
      const r=b.getBoundingClientRect();
      b.style.setProperty('--x',(e.clientX-r.left)+'px');
      b.style.setProperty('--y',(e.clientY-r.top)+'px');
    }
    document.addEventListener('pointerdown', setRipple, {passive:true});

    // Service Worker kaydı (offline çalışma)
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js'));
    }

    /* =========================
       12) BAŞLAT (init)
       ========================= */
    (async function init(){
      await idbOpen();
      entries = await idbAll();
      weighs = await idbAllWeigh();
      // Tarih alanlarını bugünün tarihi ile doldur
      dateInput.value = todayISO();
      wDate.value = todayISO();

      // Kas grupları ve hareketleri doldur
      populateGroups();
      populateMovements(); // ilk grubu seçer ve exerciseInput'u senkronlar

      // Geçmiş seçeneklerini doldur + ekranı çiz
      fillExerciseOptions(); render(); renderWeighs();

      // Küçük animasyonların hedeflerini bağla
      if (window.autoAnimate) {
        window.autoAnimate(setsBox);
        window.autoAnimate(listDiv);
        window.autoAnimate(wList);
      }
    })();
  </script>
</body>
</html>
