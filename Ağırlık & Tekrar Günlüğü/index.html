<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SetLog – Ağırlık & Tekrar Günlüğü</title>

  <!-- iOS PWA meta -->
 <link rel="apple-touch-icon" href="icons/app-180.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="SetLog">

  <style>
    :root{
      --bg:#121212; --card:#1e1e1e; --text:#ffffff; --accent:#4caf50; --muted:#9aa0a6;
      --danger:#ff6464; --warn:#ffb74d; --ok:#81c784;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;background:linear-gradient(0deg,rgba(18,18,18,.7),var(--bg));backdrop-filter:blur(6px);z-index:10}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:0 0 8px}
    .card{background:var(--card);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    label{display:block;font-size:13px;color:var(--muted);margin:6px 0 4px}
    input,select,button,textarea{
      width:100%;padding:12px;border-radius:12px;border:1px solid #2a2a2a;background:#151515;color:var(--text);
    }
    button{background:var(--accent);border:none;font-weight:600;cursor:pointer}
    button.ghost{background:#151515}
    button.danger{background:var(--danger)}
    .row{display:grid;gap:12px}
    @media(min-width:720px){.row.cols-2{grid-template-columns:1fr 1fr}}
    .set-row{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-top:8px}
    .set-row button{width:auto;padding:0 10px}
    .badge{display:inline-block;background:#222;padding:4px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
    .flex{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    canvas{width:100%;height:120px;background:#101010;border-radius:12px}
    .list{border-top:1px solid #2a2a2a;margin-top:8px}
    .item{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #2a2a2a}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .hint{font-size:12px;color:var(--muted)}
    .sp{height:8px}
  </style>
</head>
<body>
<header><div class="wrap">
  <h1>SetLog <span class="badge">offline</span></h1>
  <div class="hint">Ağırlık–tekrarları tarih tarih kaydet, ilerlemeyi takip et. Veriler cihazında kalır.</div>
</div></header>

<main class="wrap">
  <!-- Kayıt Ekle -->
  <section class="card">
    <h2 style="margin:0 0 8px">Yeni Kayıt</h2>
    <div class="row cols-2">
      <div>
        <label>Tarih</label>
        <input type="date" id="dateInput"/>
      </div>
      <div>
        <label>Hareket</label>
        <input type="text" id="exerciseInput" placeholder="Örn: Bench Press" list="exerciseList"/>
        <datalist id="exerciseList"></datalist>
      </div>
    </div>

    <div id="setsBox">
      <label>Setler (kg × tekrar)</label>
      <div class="set-row">
        <input inputmode="decimal" id="w0" placeholder="kg">
        <input inputmode="numeric" id="r0" placeholder="tekrar">
        <button type="button" class="ghost" onclick="removeSet(this)">Sil</button>
      </div>
    </div>
    <div class="sp"></div>
    <div class="flex">
      <button type="button" class="ghost" onclick="addSet()">+ Set Ekle</button>
      <div class="right"></div>
      <button type="button" onclick="saveEntry()">Kaydet</button>
    </div>
    <div class="sp"></div>
    <div class="hint">e1RM (Epley) her set için hesaplanır: kg × (1 + tekrar/30)</div>
  </section>

  <!-- Filtre / Grafik -->
  <section class="card">
    <h2 style="margin:0 0 8px">Geçmiş & İlerleme</h2>
    <div class="row cols-2">
      <div>
        <label>Hareket seç</label>
        <select id="filterExercise"></select>
      </div>
      <div>
        <label>Sırala</label>
        <select id="sortMode">
          <option value="dateDesc">Tarih ↓ (Yeni-Eski)</option>
          <option value="dateAsc">Tarih ↑ (Eski-Yeni)</option>
          <option value="bestSet">En İyi e1RM</option>
        </select>
      </div>
    </div>
    <div class="sp"></div>
    <canvas id="chart"></canvas>
    <div class="sp"></div>
    <div class="flex">
      <button class="ghost" onclick="exportJSON()">Dışa Aktar (JSON)</button>
      <input type="file" accept="application/json" id="importFile" style="display:none" />
      <button class="ghost" onclick="document.getElementById('importFile').click()">İçe Aktar</button>
      <div class="right"></div>
      <button class="danger" onclick="wipeData()">Tüm Veriyi Sil</button>
    </div>
    <div class="sp"></div>
    <div id="list" class="list"></div>
  </section>
</main>

<script>
/* ===== Basit IndexedDB Wrapper ===== */
const DB_NAME='setlog-db', STORE='entries', DB_VER=1;
let db;

function idbOpen(){
  return new Promise((res,rej)=>{
    const req=indexedDB.open(DB_NAME,DB_VER);
    req.onupgradeneeded=e=>{
      const d=e.target.result;
      if(!d.objectStoreNames.contains(STORE)){
        const os=d.createObjectStore(STORE,{keyPath:'id',autoIncrement:true});
        os.createIndex('by_exercise','exercise',{unique:false});
        os.createIndex('by_date','date',{unique:false});
      }
    };
    req.onsuccess=()=>{db=req.result;res()}
    req.onerror=()=>rej(req.error);
  });
}
function idbAdd(obj){
  return new Promise((res,rej)=>{
    const tx=db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).add(obj).onsuccess=()=>res();
    tx.onerror=()=>rej(tx.error);
  });
}
function idbAll(){
  return new Promise((res,rej)=>{
    const tx=db.transaction(STORE,'readonly');
    const data=[];
    tx.objectStore(STORE).openCursor().onsuccess=e=>{
      const cur=e.target.result;
      if(cur){ data.push(cur.value); cur.continue(); } else res(data);
    }
    tx.onerror=()=>rej(tx.error);
  });
}
function idbClear(){
  return new Promise((res,rej)=>{
    const tx=db.transaction(STORE,'readwrite');
    tx.objectStore(STORE).clear().onsuccess=()=>res();
    tx.onerror=()=>rej(tx.error);
  });
}

/* ===== UI & Mantık ===== */
const dateInput=document.getElementById('dateInput');
const exerciseInput=document.getElementById('exerciseInput');
const exerciseList=document.getElementById('exerciseList');
const setsBox=document.getElementById('setsBox');
const filterExercise=document.getElementById('filterExercise');
const sortMode=document.getElementById('sortMode');
const listDiv=document.getElementById('list');
const chartEl=document.getElementById('chart');
const importFile=document.getElementById('importFile');

let entries=[];

function todayISO(){
  const t=new Date(); const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,'0'), d=String(t.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

function addSet(weight='',reps=''){
  const i=document.createElement('div');
  i.className='set-row';
  i.innerHTML=`
    <input inputmode="decimal" placeholder="kg" value="${weight}">
    <input inputmode="numeric" placeholder="tekrar" value="${reps}">
    <button type="button" class="ghost" onclick="removeSet(this)">Sil</button>
  `;
  setsBox.appendChild(i);
}
function removeSet(btn){
  const rows=[...setsBox.querySelectorAll('.set-row')];
  if(rows.length<=1){ // son set kalır
    rows[0].querySelectorAll('input').forEach(i=>i.value='');
    return;
  }
  btn.parentElement.remove();
}

function getSets(){
  const rows=[...setsBox.querySelectorAll('.set-row')];
  const arr=[];
  for(const r of rows){
    const w=parseFloat(r.children[0].value.replace(',','.'));
    const rep=parseInt(r.children[1].value,10);
    if(!isNaN(w) && !isNaN(rep) && w>0 && rep>0) arr.push({w,rep});
  }
  return arr;
}
function epley(w,rep){ return w*(1+rep/30); } // e1RM tahmini

async function saveEntry(){
  const date=dateInput.value || todayISO();
  const exercise=exerciseInput.value.trim();
  const sets=getSets();
  if(!exercise){ alert('Hareket adı gerekli'); return; }
  if(sets.length===0){ alert('En az 1 set ekleyin'); return; }
  const payload={date, exercise, sets, ts:Date.now()};
  await idbAdd(payload);
  entries=await idbAll();
  fillExerciseOptions();
  exerciseInput.value='';
  setsBox.innerHTML='';
  addSet();
  render();
}

function fillExerciseOptions(){
  const names=[...new Set(entries.map(e=>e.exercise))].sort((a,b)=>a.localeCompare(b,'tr'));
  exerciseList.innerHTML=names.map(n=>`<option value="${n}">`).join('');
  filterExercise.innerHTML=['<option value="__all__">Tümü</option>', ...names.map(n=>`<option>${n}</option>`)].join('');
}

function render(){
  // filtre + sıralama
  let filtered=[...entries];
  const f=filterExercise.value;
  if(f && f!=='__all__') filtered=filtered.filter(e=>e.exercise===f);

  const mode=sortMode.value;
  if(mode==='dateDesc') filtered.sort((a,b)=>b.date.localeCompare(a.date));
  else if(mode==='dateAsc') filtered.sort((a,b)=>a.date.localeCompare(b.date));
  else if(mode==='bestSet'){
    filtered.sort((a,b)=>{
      const maxA=Math.max(...a.sets.map(s=>epley(s.w,s.rep)));
      const maxB=Math.max(...b.sets.map(s=>epley(s.w,s.rep)));
      return maxB-maxA;
    });
  }

  // liste
  listDiv.innerHTML=filtered.map(item=>{
    const best=Math.max(...item.sets.map(s=>epley(s.w,s.rep)));
    const setsTxt=item.sets.map(s=>`${s.w}kg×${s.rep}`).join('  •  ');
    return `<div class="item">
      <div>
        <div><strong>${item.exercise}</strong> <span class="badge">${item.date}</span></div>
        <div class="hint mono">${setsTxt}</div>
      </div>
      <div class="mono" title="e1RM (Epley)">≈ ${best.toFixed(1)} kg</div>
    </div>`;
  }).join('');

  // grafik: seçili hareket için tarih–en iyi e1RM çizgisi (küçük, bağımsız çizim)
  drawChart();
}

function drawChart(){
  const ctx=chartEl.getContext('2d');
  ctx.clearRect(0,0,chartEl.width,chartEl.height);
  // canvas boyutları (CSS'ten farklı olabilir)
  const w=chartEl.width=chartEl.clientWidth*2; // retina keskinliği
  const h=chartEl.height=chartEl.clientHeight*2;

  const f=filterExercise.value;
  if(!f || f==='__all__'){
    // Tüm kayıtlar için gösterilecek veri yoksa boşalt
    ctx.fillStyle="#666"; ctx.font="28px system-ui";
    ctx.fillText("Grafik için bir hareket seçin", 24, 54);
    return;
  }
  const perDate=new Map();
  entries.filter(e=>e.exercise===f).forEach(e=>{
    const best=Math.max(...e.sets.map(s=>epley(s.w,s.rep)));
    perDate.set(e.date, Math.max(perDate.get(e.date)||0, best));
  });
  const points=[...perDate.entries()].sort((a,b)=>a[0].localeCompare(b[0]));

  if(points.length<2){
    ctx.fillStyle="#666"; ctx.font="28px system-ui";
    ctx.fillText("Grafik için en az 2 gün kayıt girin", 24, 54);
    return;
  }

  const xs=points.map((p,i)=>i);
  const ys=points.map(p=>p[1]);
  const minY=Math.min(...ys), maxY=Math.max(...ys);
  const pad=40;
  const X=i=>pad + i*( (w-2*pad)/(xs.length-1) );
  const Y=v=>{
    const t=(v-minY)/(maxY-minY || 1);
    return (h-pad) - t*(h-2*pad);
  }

  // eksenler
  ctx.strokeStyle="#333"; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, h-pad); ctx.lineTo(w-pad, h-pad); ctx.stroke();

  // çizgi
  ctx.strokeStyle="#4caf50"; ctx.lineWidth=4; ctx.beginPath();
  points.forEach((p,i)=>{ const x=X(i), y=Y(p[1]); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
  ctx.stroke();

  // noktalar
  ctx.fillStyle="#4caf50";
  points.forEach((p,i)=>{ const x=X(i), y=Y(p[1]); ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill(); });

  // etiketler (son nokta + min/max)
  ctx.fillStyle="#9aa0a6"; ctx.font="24px system-ui";
  const last=points[points.length-1];
  ctx.fillText(`${last[0]} ≈ ${last[1].toFixed(1)}kg`, X(points.length-1)+8, Y(last[1])-8);
}

function exportJSON(){
  const blob=new Blob([JSON.stringify(entries)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download='setlog-export.json'; a.click(); URL.revokeObjectURL(a.href);
}
importFile.addEventListener('change', async e=>{
  const file=e.target.files[0]; if(!file) return;
  const text=await file.text();
  try{
    const arr=JSON.parse(text);
    if(!Array.isArray(arr)) throw new Error('Geçersiz dosya');
    await idbClear();
    await Promise.all(arr.map(o=>idbAdd(o)));
    entries=await idbAll();
    fillExerciseOptions(); render();
    alert('İçe aktarıldı.');
  }catch(err){ alert('Hata: '+err.message); }
});

async function wipeData(){
  if(!confirm('Tüm verileri silmek istediğine emin misin?')) return;
  await idbClear(); entries=[]; fillExerciseOptions(); render();
}

/* ===== PWA ===== */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js'));
}

/* ===== İlk Açılış ===== */
(async function init(){
  await idbOpen();
  entries=await idbAll();
  dateInput.value=todayISO();
  addSet();
  fillExerciseOptions();
  render();
})();
</script>
</body>
</html>
